#!/usr/bin/env node

import fs from 'fs/promises';
import path from 'path';
import yaml from 'js-yaml';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const repoRoot = path.resolve(__dirname, '..');

const baseConfigPath = path.join(repoRoot, 'public', 'admin', 'config.base.yml');
const outputConfigPath = path.join(repoRoot, 'public', 'admin', 'config.yml');
const foldersDir = path.join(repoRoot, 'src', 'content', 'folders');

const FOLDER_EMOJIS = {
  featured: 'â­',
  sketches: 'âœï¸',
  commission: 'ðŸ’¼',
  default: 'ðŸ“',
};

const readJson = async filePath => {
  const raw = await fs.readFile(filePath, 'utf8');
  return JSON.parse(raw);
};

const loadFolders = async () => {
  const entries = await fs.readdir(foldersDir);
  const folders = [];
  for (const entry of entries.filter(file => file.endsWith('.json'))) {
    const fullPath = path.join(foldersDir, entry);
    const data = await readJson(fullPath);
    if (data.hidden) continue;
    folders.push(data);
  }
  return folders;
};

const sortByOrderThenName = (a, b) => {
  const orderDiff = (a.order ?? Number.MAX_SAFE_INTEGER) - (b.order ?? Number.MAX_SAFE_INTEGER);
  if (orderDiff !== 0) {
    return orderDiff;
  }
  return a.name.localeCompare(b.name);
};

const getEmoji = folderId => {
  for (const [prefix, emoji] of Object.entries(FOLDER_EMOJIS)) {
    if (folderId.startsWith(prefix)) {
      return emoji;
    }
  }
  return FOLDER_EMOJIS.default;
};

const buildFilters = folders => {
  const topLevel = folders.filter(folder => !folder.parentId).sort(sortByOrderThenName);
  const children = folders.filter(folder => folder.parentId);
  const filters = [];

  for (const folder of topLevel) {
    filters.push({
      label: `${getEmoji(folder.id)} ${folder.name} (All)`,
      field: 'folderId',
      pattern: `^${folder.id}`,
    });
  }

  children
    .sort((a, b) =>
      `${a.parentId ?? ''}${a.order ?? ''}${a.name}`.localeCompare(
        `${b.parentId ?? ''}${b.order ?? ''}${b.name}`
      )
    )
    .forEach(child => {
      const parent = topLevel.find(folder => folder.id === child.parentId);
      if (!parent) {
        return;
      }
      filters.push({
        label: `ðŸ—‚ï¸ ${parent.name} â€º ${child.name}`,
        field: 'folderId',
        pattern: `^${child.id}$`,
      });
    });

  return filters;
};

const ensureImagesCollection = config => {
  const imagesCollection = config.collections?.find(collection => collection.name === 'images');
  if (!imagesCollection) {
    throw new Error('Unable to find "images" collection in config.base.yml');
  }
  return imagesCollection;
};

const run = async () => {
  const baseRaw = await fs.readFile(baseConfigPath, 'utf8');
  const config = yaml.load(baseRaw);
  if (!config || typeof config !== 'object') {
    throw new Error('Invalid base config');
  }

  const folders = await loadFolders();
  const filters = buildFilters(folders);
  const imagesCollection = ensureImagesCollection(config);
  imagesCollection.view_filters = filters;
  imagesCollection.view_groups = [
    {
      label: 'Folder',
      field: 'folderId',
      pattern: '(.+)',
      default: true,
    },
  ];

  const generated = [
    '# âš ï¸ This file is auto-generated by scripts/build-cms-config.mjs',
    '#    Edit public/admin/config.base.yml instead.',
    yaml.dump(config, { lineWidth: 100 }),
  ].join('\n');

  await fs.writeFile(outputConfigPath, generated);
  console.log(`CMS config generated with ${filters.length} filters.`);
};

run().catch(error => {
  console.error(error.message);
  process.exit(1);
});
